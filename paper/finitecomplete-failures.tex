% ==========================================================================
\section{Finite Complete Test Suites for CSP Failures Refinement}
\label{sec:finitecompletefails}
% ==========================================================================



Given a finite-state CSP process $P$ and its normalised transition graph 
\[
G(P) = ( N, \ii n, \Sigma, t : N\times\Sigma \pfun N, r : N \fun \mathbb{P}\mathbb{P}(\Sigma)),
\]
suppose that $V\subseteq\Sigma^*$ is a 
prefix-closed set  of sequences of events. By $t(\ii n,V)$ we denote the set
\[
t(\ii n,V) = \{ n\in N~|~\exists s\in V: s\in\trc(P)\wedge G(P)/s = n \}
\] 
of nodes in $N$ that are reachable in $G(P)$ by applying traces of $V$.

\begin{lemma}
\label{lemma:extendV}
Let $P$ be a CSP process with normalised transition graph $G(P)$, 
such that all states in $N$ are reachable.
Let $V\subseteq\Sigma^*$ be a finite prefix-closed set of
sequences of events. Suppose that  $G(P)$ reaches $k < |N|$ nodes under $V$, that is,
$|t(\ii n,V)| = k$. Let $V.\Sigma$ denote the set of all sequences from $V$, extended by an event of $\Sigma$.
Then $G(P)$ reaches at least $(k+1)$ nodes under $V\cup V.\Sigma$.
\end{lemma}
\begin{proof}
Suppose that $n'\in (N - t(\ii n,V))$.  Since all nodes in $N$ are reachable, there exists
a trace $s$ such that $G(P)/s = n'$. Decompose $s = s_1.e.s_2$ with $s_i\in\Sigma^*, e\in\Sigma$, such that $G(P)/s_1 \in t(\ii n,V)$ and $G(P)/s_1.e \not\in t(\ii n,V)$. Such a decomposition always exists, because $V$ is prefix-closed and therefore contains the empty trace $\varepsilon$. Note, however, that it is not necessarily the case that $s_1\in V$.

Since $G(P)$ reaches $G(P)/s_1$ under $V$, there exists a trace $u\in V$ such that
$\ol n = G(P)/u = G(P)/s_1$. Since $s = s_1.e.s_2$ is a trace of $P$ and $n = G(P)/s_1$,
$(\ol u,e)$ is in the domain of $t$, therefore,  
$n = G(P)/u.e = G(P)/s_1.e \not\in t(\ii n,V)$ is a well-defined node
of $N$ which is not contained in $t(\ii n,V)$. Since $u.e\in V\cup V.\Sigma$,
$G(P)$ reaches at least the additional node $n$ under $V\cup V.\Sigma$. This completes the proof.
\xbox
\end{proof}














% ==========================================================================
\subsection{Test Cases for Verifying CSP Failures Refinement}

For a given reference process $P$ and for each $n\ge 0$, 
we define a CSP test process as follows. 
\begin{eqnarray}
U_F(n) & = & U_F(n,\varepsilon)
\\
U_F(n,s) & = & \big( e:(\Sigma - [P/s]^0) \then \dag\then \Skip \big)
\label{eq:ufa}
\\ & & \extchoice \nonumber
\\ & & ([P/s]^0 = \varnothing)    \&   \big( \omega \then \Skip \big)
\label{eq:ufb}
\\ & & \extchoice \nonumber
\\ & & (\#s < n) \& \big( e:[P/s]^0 \then U_F(n,s.e) \big)
\label{eq:ufc}
\\ & & \extchoice \nonumber
\\ & & (\#s = n) \& \big( \sqcap_{H\in\text{MINHIT}(P/s)} ( e:H \then \omega \then\Skip   )  \big)
\label{eq:ufd}
\end{eqnarray}

A test is performed by running $U_F(n)$ concurrently with any SUT process $Q$
that operates on the same alphabet as $P$, synchronising over
alphabet $\Sigma$. Therefore, a test execution is any trace of the concurrent process
\[
Q\parallel[\Sigma] U_F(n).
\]
It is assumed that the events $\dag$ and $\omega$ denoting FAIL and PASS of the test execution, respectively, are events outside $\Sigma$.
Since we assume that $Q$ is free of livelocks, it is guaranteed that each test execution terminates after some $s\in\trc(P)$ with length $(n+1)$ at the latest. 
The test is \emph{passed} by the SUT (we write $Q\ \pass\ U(n)$) if and only if {\it every} execution of $Q\parallel[\Sigma] U_F(n)$ terminates with PASS event $\omega$. This can also be  expressed by means of a trace equivalence relation:
\[
Q\ \pass\ U(n) \equiv  (Q\parallel[\Sigma] U_F(n)) \hide \Sigma =_T (\omega\then\Skip)
\]
This type of pass relation is often called \emph{must test}, because every test execution must end with the PASS event $\omega$ \cite{Hennessy:1988:ATP:50497}.


Intuitively speaking, $U_F(n)$ is able to perform any trace $s$ of $P$, 
up to a length of $n$. If, after having already run through $s\in\trc(P)$ with $\#s < n$,
an event is accepted by the SUT which is outside the initials of $P/s$, the test 
immediately terminates with FAIL-event $\dag$. This is handled by the first operand of the
external choice in sub-process $U(n,s)$.

If $P/s$ is the STOP-process, this is revealed by its initials being empty. In this case, the test may terminate 
successfully (second operand of the external choice in $U(n,s)$). Note that at the same time, any (now illegal) event of the alphabet is also accepted by the test.
Therefore,
if the SUT would still accept an event in a state where $P/s$ is supposed to have stopped, there exists a test execution which terminates with FAIL by choosing the first
operand of the external choice.

If the length of $s$ is still less than $n$, the test accepts any event from the initials
$[P/s]^0$ and continues recursively as sub-process $U(n,s.e)$ (third operand of the external choice). A test of this type is called \emph{adaptive}, because it accepts any legal behaviour of the SUT and adapts its consecutive behaviour to the event selected by the SUT.
 
After having  run successfully 
through a trace of length $n$, the test changes its behaviour:
instead of offering {\it all} legal events from $[P/s]^0$ to the SUT, 
it nondeterministically chooses 
a minimal hitting set of $\minaccs(P/s)$ and only offers the events contained in this set.
If the SUT refuses to engage into any of these events, this reveals a violation of the
failures refinement: according to Lemma~\ref{lemma:hseta}, a conforming SUT should accept
at least one event of each minimal hitting set in $\text{MINHIT}(P/s)$. Therefore, the test
only terminates with success $\omega$, if such an event is accepted by the SUT.

After this informal explanation of tests representing adaptive test cases, we are ready to prove the main theorem of this paper.

\begin{theorem}
Let $P$ be a divergence-free CSP process over alphabet $\Sigma$ 
whose normalised transition graph $G(P)$ has $n$ states. Define fault domain ${\cal D}$ as
the set of all divergence-free CSP processes over alphabet $\Sigma$, whose transition graph
has at most $m$ states with $m \ge n$. 
Then the test suite 
\[
\TS_F = \{ U_F(k)~|~0 \le k \le nm  \}
\]
is complete with respect to ${\cal F} = (P,\lessdet_F,{\cal D})$.
\end{theorem}
\begin{proof}
To prove soundness of $\TS_F$, suppose that $Q\in{\cal D} \wedge P\lessdet_F Q$. Then
$\trc(Q)\subseteq \trc(P)$, and Lemma~\ref{lemma:hseta} implies that 
for all traces $s$ of $Q$, every $H\in\text{MINHIT}(P/s)$ is a 
    hitting set for $\minaccs(Q/s)$. As a consequence, when running in parallel
with $Q$, any adaptive test $U_F(n)$ will always enter the branches 
(\ref{eq:ufb}), (\ref{eq:ufc}),  or (\ref{eq:ufd}) of the external choice construction
for $U_F(n,s)$. Branch (\ref{eq:ufb}) always leads to a PASS verdict, branch (\ref{eq:ufc})
always to test continuation without a verdict. For the last branch, we note that 
any selected minimal hitting set $H\in\text{MINHIT}(P/s)$ has a non-empty intersection with
each of the minimal acceptances of $Q/s$. As a consequence, $Q/s$ will never block when offered events from $H$, and the test terminates with PASS event $\omega$. Note that this argument requires that $Q$ is free of livelocks, because otherwise the PASS-events might not become visible, due to unbounded sequences of hidden events performed by $Q$. Note further, that this proof did not refer in any way to the size of $Q$'s normalised transition graph, so the test suite is sound for {\it all} non-divergent CSP process refining $P$.

To prove exhaustiveness, consider a process $Q\in{\cal D}$ with $P\not\lessdet_F Q$. This non-conformance can be caused in two possible ways.
\begin{enumerate}
\item $\trc(Q)\not\subseteq \trc(P)$
\item There exists a joint trace $s\in\trc(Q)\cap\trc(P)$ and a minimal acceptance $A_Q$
of $\minaccs(Q/s)$, such that 
(see Lemma~\ref{lemma:tgtrcref}, (\ref{eq:failrefb})).
\[
\forall A_P\in\minaccs(P/s): A_P\not\subseteq A_Q,
\] 
\end{enumerate}
It has to be shown for each of the two possibilities that at least one test execution of some $(Q\parallel[\Sigma] U(k))$ with $k\le nm$ ends with the FAIL event $\dag$.
\xbox
\end{proof}


















% ==========================================================================
